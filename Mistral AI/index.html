<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智能訂位助理 — 就近找餐廳 & 一鍵代訂</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --panel-2:#0e1630; --text:#e9eefc; --muted:#a9b3cf; --accent:#6aa9ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#111827; --chip:#1f2a44; }
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";margin:0}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .toolbar{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0));border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.25);border-radius:16px;padding:18px;display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .controls{display:grid;grid-template-columns:1fr 130px 110px 110px;gap:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);color:var(--text);border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid rgba(255,255,255,0.08)}
    input[type="text"],input[type="number"],input[type="datetime-local"]{width:100%;background:#0f172a;color:var(--text);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;outline:none}
    input[type="checkbox"]{transform:translateY(1px)}
    select{background:#0f172a;color:var(--text);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;outline:none}
    .btn{background:#2b3b74;color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#334155}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.15)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:18px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{position:relative;padding-top:58%;background:#0b1226}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
    .badge.right{left:auto;right:10px}
    .body{padding:12px 12px 8px 12px;display:grid;gap:8px}
    .title{font-weight:700}
    .addr{color:var(--muted);font-size:13px;line-height:1.4}
    .meta{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
    .open{background:var(--ok)}
    .close{background:var(--bad)}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px}
    .sub{padding:10px;font-size:12px;color:var(--muted);border-top:1px dashed rgba(255,255,255,0.08)}
    .status{margin-top:14px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;background:#0a1226;border:1px solid rgba(255,255,255,0.08);padding:12px;border-radius:12px;color:#d6e1ff}
    .row2{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    @media (max-width:720px){.controls{grid-template-columns:1fr}.row2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 10px 0">🍽️ 智能訂位助理 <span style="font-weight:400;color:var(--muted);font-size:16px">（就近搜尋 × 一鍵代訂）</span></h1>

    <div class="toolbar">
      <div class="controls">
        <input id="q" type="text" placeholder="輸入：今晚 19:00 2位 拉麵 在信義區；或直接說『今晚 19:00 2位 壽司』" />
        <input id="party" type="number" min="1" value="2" title="人數（可選）" />
        <input id="dt" type="datetime-local" title="時間（可選）」" />
        <button class="btn" id="btnPlan">解析 + 找店</button>
      </div>
      <div class="row">
        <div class="chips">
          <label class="chip"><input id="usegeo" type="checkbox" checked style="margin-right:6px">使用我的位置</label>
          <span class="chip">📍 <span id="geotext">尚未取得 GPS</span></span>
          <span class="chip">半徑 <span id="radv">3000</span> m</span>
          <input id="radius" type="range" min="500" max="10000" step="100" value="3000" style="width:160px">
          <span class="chip">排序
            <select id="sortSel">
              <option value="rating">評分優先</option>
              <option value="distance">距離優先（需 GPS）</option>
              <option value="open">營業中優先</option>
              <option value="reviews">評論數優先</option>
            </select>
          </span>
          <label class="chip"><input id="openOnly" type="checkbox" style="margin-right:6px">只看營業中</label>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ghost" id="btnClear">清空</button>
          <button class="btn secondary" id="btnBook">一句話自動訂位</button>
        </div>
      </div>
    </div>

    <div id="result" class="grid"></div>

    <div id="status" class="status" style="display:none"></div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const statusBox = $('#status');
    const resultGrid = $('#result');

    let currentPlan = null;
    let lastCandidates = [];
    let GEO = null;

    function showStatus(obj){ statusBox.style.display='block'; statusBox.textContent=(typeof obj==='string')?obj:JSON.stringify(obj,null,2); }
    function clearStatus(){ statusBox.style.display='none'; statusBox.textContent=''; }

    function priceMarks(n){ if(n==null) return '—'; return '$'.repeat(Math.min(4, Math.max(1, n))); }
    function stars(r){ if(!r) return '—'; const s = Number(r).toFixed(1); return `★ ${s}`; }
    function phoneTel(p){ return p ? `tel:${String(p).replace(/\s/g,'')}` : null; }

    // Haversine 距離（公尺）
    function distMeters(a,b){
      if(!a||!b) return Infinity;
      const toRad = d=>d*Math.PI/180;
      const R=6371000; // m
      const dLat=toRad((b.lat-a.lat)), dLng=toRad((b.lng-a.lng));
      const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    }

    function formatDist(m){ if(!isFinite(m)) return ''; return (m<1000)? `${Math.round(m)} m` : `${(m/1000).toFixed(1)} km`; }

    function sortList(list){
      const mode = $('#sortSel').value;
      const openOnly = $('#openOnly').checked;
      let arr = [...list];
      if(openOnly) arr = arr.filter(x=>x.open_now===true);
      if(mode==='distance'){
        if(!GEO){ alert('需要允許定位才能依距離排序'); return arr; }
        arr.forEach(x=>{ x._dist = distMeters(GEO,{lat:x.lat,lng:x.lng}); });
        arr.sort((a,b)=> (a._dist||Infinity) - (b._dist||Infinity));
      } else if(mode==='open'){
        arr.sort((a,b)=> (b.open_now===true)-(a.open_now===true) || (b.rating||0)-(a.rating||0));
      } else if(mode==='reviews'){
        arr.sort((a,b)=> (b.user_ratings_total||0)-(a.user_ratings_total||0));
      } else { // rating
        arr.sort((a,b)=> (b.rating||0)-(a.rating||0) || (b.user_ratings_total||0)-(a.user_ratings_total||0));
      }
      return arr;
    }

    function render(list){
      resultGrid.innerHTML='';
      const arr = sortList(list||[]);
      if(!arr.length){ resultGrid.innerHTML='<div class="card" style="padding:16px">沒有找到候選餐廳。</div>'; return; }
      arr.forEach((r)=>{
        const card=document.createElement('div'); card.className='card';
        const img=document.createElement('div'); img.className='thumb'; img.innerHTML=`<img alt="photo" src="${r.photo_url||''}">`;
        const price=document.createElement('div'); price.className='badge'; price.textContent=priceMarks(r.price_level); img.appendChild(price);
        if(typeof r._dist==='number'){
          const distB=document.createElement('div'); distB.className='badge right'; distB.textContent=formatDist(r._dist); img.appendChild(distB);
        }
        const body=document.createElement('div'); body.className='body';
        body.innerHTML=`
          <div class="title">${r.name||'—'}</div>
          <div class="meta">
            <span>${stars(r.rating)}（${r.user_ratings_total||0} 評）</span>
            <span class="dot ${r.open_now? 'open':'close'}"></span>
            <span>${r.open_now? '營業中':'可能休息'}</span>
          </div>
          <div class="addr">${r.address||''}</div>`;

        const actions=document.createElement('div'); actions.className='actions';
        const btnCall=document.createElement('button'); btnCall.className='btn'; btnCall.textContent='代為致電訂位';
        btnCall.onclick=async()=>{ if(!currentPlan){return alert('請先執行「解析 + 找店」或「一句話自動訂位」。');}
          showStatus({hint:'calling…',restaurant:r});
          const payload={plan:currentPlan,restaurant:r,mode:'call'};
          const res=await fetch('/confirm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const data=await res.json(); showStatus(data);
        };
        const btnBridge=document.createElement('button'); btnBridge.className='btn secondary'; btnBridge.textContent='先撥給我再轉接';
        btnBridge.onclick=async()=>{ if(!currentPlan){return alert('請先執行「解析 + 找店」或「一句話自動訂位」。');}
          showStatus({hint:'bridging…',restaurant:r});
          const payload={plan:currentPlan,restaurant:r,mode:'call_and_bridge'};
          const res=await fetch('/confirm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const data=await res.json(); showStatus(data);
        };
        const btnManual=document.createElement('button'); btnManual.className='btn ghost'; btnManual.textContent='我自己線上訂位';
        btnManual.onclick=async()=>{ const payload={plan:currentPlan||{},restaurant:r,mode:'link_only'};
          const res=await fetch('/confirm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const data=await res.json(); if(data.url){window.open(data.url,'_blank');} showStatus(data);
        };
        const btnNav=document.createElement('button'); btnNav.className='btn ghost'; btnNav.textContent='導航到這裡';
        btnNav.onclick=()=>{ if(r.maps_nav_url) window.open(r.maps_nav_url,'_blank'); };
        actions.append(btnCall,btnBridge,btnManual,btnNav);

        const sub=document.createElement('div'); sub.className='sub';
        const oh=(r.opening_hours||[]).join(' / ');
        const tel=phoneTel(r.phone);
        sub.innerHTML=`<div>電話：${ r.phone? `<a href="${tel}">${r.phone}</a>`:'—' } ｜ 官網：${ r.website? `<a href="${r.website}" target="_blank">開啟</a>`:'—' } ｜ 地圖：${ r.maps_url? `<a href="${r.maps_url}" target="_blank">開啟</a>`:'—' }</div>
          <div style="margin-top:4px">營業時間：${oh||'—'}</div>`;

        card.append(img,body,actions,sub); resultGrid.appendChild(card);
      });
    }

    async function getGeo(){
      if(!$('#usegeo').checked){ GEO=null; $('#geotext').textContent='未使用 GPS'; return null; }
      if(!navigator.geolocation){ GEO=null; $('#geotext').textContent='瀏覽器不支援定位'; return null; }
      return new Promise(resolve=>{
        navigator.geolocation.getCurrentPosition(
          p=>{ GEO={lat:p.coords.latitude,lng:p.coords.longitude}; $('#geotext').textContent=`${GEO.lat.toFixed(5)}, ${GEO.lng.toFixed(5)}`; resolve(GEO); },
          _=>{ GEO=null; $('#geotext').textContent='定位失敗'; resolve(null); },
          {enableHighAccuracy:true,timeout:6000}
        );
      });
    }

    async function plan(){
      clearStatus(); resultGrid.innerHTML='<div class="card" style="padding:16px">搜尋中…</div>';
      const text=$('#q').value.trim()||'今天晚上 19:00 2位 拉麵 在台北';
      const party=Number($('#party').value||'');
      const dt=$('#dt').value; // 可留空，後端會自動補
      const mix=text + (party? `，${party}位`: '') + (dt? `，${new Date(dt).toLocaleString()}`:'');
      await getGeo();
      const body=GEO? {text:mix,lat:GEO.lat,lng:GEO.lng,radius_m:Number($('#radius').value)} : {text:mix};
      const res=await fetch('/plan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data=await res.json();
      if(data.error){ showStatus(data); resultGrid.innerHTML=''; return; }
      currentPlan=data.plan||null; lastCandidates=data.candidates||[];
      // 先附距離供排序顯示
      if(GEO){ lastCandidates.forEach(x=> x._dist = distMeters(GEO,{lat:x.lat,lng:x.lng})); }
      render(lastCandidates); showStatus({plan:currentPlan,candidates:lastCandidates});
    }

    async function book(){
      clearStatus(); resultGrid.innerHTML='<div class="card" style="padding:16px">處理中…</div>';
      const text=$('#q').value.trim()||'今晚 19:00 2位 義大利麵 在信義區';
      await getGeo();
      const body=GEO? {text,lat:GEO.lat,lng:GEO.lng,radius_m:Number($('#radius').value)} : {text};
      const res=await fetch('/book',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data=await res.json();
      if(data.error){ showStatus(data); resultGrid.innerHTML=''; return; }
      currentPlan=data.plan||currentPlan;
      if(GEO && data.restaurant){ data.restaurant._dist = distMeters(GEO,{lat:data.restaurant.lat,lng:data.restaurant.lng}); }
      if(GEO && Array.isArray(data.candidates)){ data.candidates.forEach(x=> x._dist = distMeters(GEO,{lat:x.lat,lng:x.lng})); }
      if(data.restaurant){ render([data.restaurant]); }
      else if(data.candidates){ render(data.candidates); }
      else { render([]); }
      showStatus(data);
    }

    // events
    $('#btnPlan').onclick=plan;
    $('#btnBook').onclick=book;
    $('#btnClear').onclick=()=>{ $('#q').value=''; $('#party').value=2; $('#dt').value=''; resultGrid.innerHTML=''; clearStatus(); };
    $('#radius').oninput=(e)=>{ $('#radv').textContent=e.target.value; };
    $('#sortSel').onchange=()=> render(lastCandidates);
    $('#openOnly').onchange=()=> render(lastCandidates);

    // init
    (async()=>{ await getGeo(); })();
  </script>
</body>
</html>
